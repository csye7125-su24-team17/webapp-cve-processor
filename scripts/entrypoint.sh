#!/bin/sh

echo "Starting entrypoint.sh..."

# Wait for the Istio sidecar to be ready
until curl -fsI http://127.0.0.1:15021/healthz/ready; do
  echo "Waiting for Sidecar..."
  sleep 3
done

echo "Sidecar up, running main application..."
./main
x=$?
echo "Main application exited with status $x"

# Check if the main application failed
if [ $x -ne 0 ]; then
  echo "Main application failed with status $x"
fi

# Signal Envoy proxy to shut down gracefully
echo "Sending quitquitquit to Envoy..."
curl -fsI -X POST http://127.0.0.1:15020/quitquitquit
echo "Sent quitquitquit to Envoy"

# Exit with the status code of the main command
exit $x
